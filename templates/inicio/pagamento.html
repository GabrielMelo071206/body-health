{% extends 'layout.html' %}

{% block content %}
    <div class="container mt-5">
        <h1 class="text-center mb-5 fw-bold text-primary">Finalizar Pagamento</h1>

        {% if erro %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ erro }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if not tem_planos %}
        <div class="alert alert-warning text-center">
            <h4>Nenhum plano disponível no momento</h4>
            <p>Por favor, entre em contato com o suporte ou tente novamente mais tarde.</p>
            <a href="/planos" class="btn btn-primary">Voltar para Planos</a>
        </div>
        {% else %}

        <div class="row g-4">
            <div class="col-md-7 order-md-1">
                <div class="card-custom">
                    <h4 class="mb-3">Escolha seu Plano</h4>
                    <div class="mb-4">
                        {% for plano in planos_pagos %}
                        <div class="form-check {% if not loop.first %}mt-2{% endif %}">
                            <input class="form-check-input plan-radio" 
                                   type="radio" 
                                   name="planType" 
                                   id="plan{{ plano.id }}" 
                                   value="{{ plano.id }}"
                                   data-nome="{{ plano.nome }}"
                                   data-preco="{{ plano.preco }}"
                                   data-duracao="{{ plano.duracao_dias }}"
                                   {% if plano_selecionado and plano.id == plano_selecionado.id %}checked{% elif not plano_selecionado and loop.first %}checked{% endif %}>
                            <label class="form-check-label" for="plan{{ plano.id }}">
                                <strong>{{ plano.nome }}</strong> - R${{ "%.2f"|format(plano.preco) }} / 
                                {% if plano.duracao_dias >= 365 %}
                                    ano
                                    {% if plano.preco < (planos_pagos[0].preco * 12) %}
                                    <span class="badge bg-success">Economize até 25%!</span>
                                    {% endif %}
                                {% elif plano.duracao_dias == 30 %}
                                    mês
                                {% else %}
                                    {{ plano.duracao_dias }} dias
                                {% endif %}
                                <br>
                                <small class="text-muted">{{ plano.descricao }}</small>
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <h4 class="mb-3">Método de Pagamento</h4>
                    <div class="payment-tabs">
                        <button class="payment-tab-button active" data-tab-target="#credit-card-content">Cartão de Crédito</button>
                        <button class="payment-tab-button" data-tab-target="#pix-content">PIX</button>
                    </div>

                    <div id="credit-card-content" class="payment-content active">
                        <form class="needs-validation" novalidate id="card-payment-form">
                            <div class="mb-3">
                                <label for="nomeCartao" class="form-label">Nome no Cartão</label>
                                <input type="text" class="form-control" id="nomeCartao" placeholder="Nome Completo (como no cartão)" required>
                                <div class="invalid-feedback">
                                    O nome no cartão é obrigatório.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="numeroCartao" class="form-label">Número do Cartão</label>
                                <input type="text" class="form-control" id="numeroCartao" placeholder="XXXX XXXX XXXX XXXX" required pattern="[0-9]{16}">
                                <div class="invalid-feedback">
                                    Um número de cartão válido é obrigatório (16 dígitos).
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="validade" class="form-label">Validade (MM/AA)</label>
                                    <input type="text" class="form-control" id="validade" placeholder="MM/AA" required pattern="(0[1-9]|1[0-2])\/[0-9]{2}">
                                    <div class="invalid-feedback">
                                        A validade é obrigatória (MM/AA).
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cvv" placeholder="XXX" required pattern="[0-9]{3,4}">
                                    <div class="invalid-feedback">
                                        O CVV é obrigatório (3 ou 4 dígitos).
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" style="border-color: var(--dark-border-color);">

                            <h4 class="mb-3">Endereço de Cobrança</h4>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="primeiroNome" class="form-label">Primeiro Nome</label>
                                    <input type="text" class="form-control" id="primeiroNome" placeholder="" value="" required>
                                    <div class="invalid-feedback">
                                        Seu primeiro nome é obrigatório.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="sobrenome" class="form-label">Sobrenome</label>
                                    <input type="text" class="form-control" id="sobrenome" placeholder="" value="" required>
                                    <div class="invalid-feedback">
                                        Seu sobrenome é obrigatório.
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="endereco" class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="endereco" placeholder="Rua, número" required>
                                <div class="invalid-feedback">
                                    Por favor, insira seu endereço de cobrança.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="endereco2" class="form-label">Endereço 2 <span class="text-muted">(Opcional)</span></label>
                                <input type="text" class="form-control" id="endereco2" placeholder="Apartamento, condomínio, etc.">
                            </div>

                            <div class="row">
                                <div class="col-md-5 mb-3">
                                    <label for="pais" class="form-label">País</label>
                                    <select class="form-select" id="pais" required>
                                        <option value="">Escolha...</option>
                                        <option>Brasil</option>
                                        <option>Estados Unidos</option>
                                        <option>Canadá</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione um país válido.
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-select" id="estado" required>
                                        <option value="">Escolha...</option>
                                        <option>SP</option>
                                        <option>RJ</option>
                                        <option>MG</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, forneça um estado válido.
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="cep" class="form-label">CEP</label>
                                    <input type="text" class="form-control" id="cep" placeholder="00000-000" required pattern="[0-9]{5}-[0-9]{3}">
                                    <div class="invalid-feedback">
                                        CEP é obrigatório.
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" style="border-color: var(--dark-border-color);">

                            <button class="w-100 btn btn-primary btn-lg" type="submit">Pagar com Cartão</button>
                        </form>
                    </div>

                    <div id="pix-content" class="payment-content">
                        <p class="text-center lead">Escaneie o QR Code ou copie o código PIX para finalizar o pagamento.</p>
                        <img src="https://via.placeholder.com/250?text=QR+Code+PIX" alt="QR Code PIX" id="pix-qr-code">
                        <div class="mb-3 pix-code-container">
                            <label for="pix-code" class="form-label">Código PIX Copia e Cola</label>
                            <input type="text" class="form-control" id="pix-code" value="00020126580014BR.GOV.BCB.PIX0136a53266e-2ba4-41d4-8395-502842e22c06520400005303986540519.905802BR5913Nome Empresa6008BRASILIA62070503***6304CA27" readonly>
                            <button class="pix-copy-btn-absolute" onclick="copyPixCode()"><i class="bi bi-clipboard"></i></button>
                            <div class="form-text text-muted">Este QR Code e código são apenas para demonstração.</div>
                        </div>
                        <button class="w-100 btn btn-success btn-lg mt-3" type="button" id="confirm-pix-payment">Já Paguei com PIX</button>
                    </div>

                </div>
            </div>

            <div class="col-md-5 order-md-2">
                <div class="card-custom">
                    <h4 class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-primary">Resumo do Pedido</span>
                    </h4>
                    <ul class="list-group mb-3">
                        <li class="list-group-item d-flex justify-content-between lh-sm">
                            <div>
                                <h6 class="my-0">Plano <span id="plano-nome">
                                    {% if plano_selecionado %}{{ plano_selecionado.nome }}{% else %}Premium{% endif %}
                                </span></h6>
                                <small class="text-muted">Acesso ilimitado à Body Health</small>
                            </div>
                            <span class="text-success" id="plano-preco">
                                {% if plano_selecionado %}R${{ "%.2f"|format(plano_selecionado.preco) }}{% else %}R$0,00{% endif %}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total (BRL)</span>
                            <strong id="total-preco">
                                {% if plano_selecionado %}R${{ "%.2f"|format(plano_selecionado.preco) }}{% else %}R$0,00{% endif %}
                            </strong>
                        </li>
                    </ul>
                    <p class="text-muted" style="font-size: 0.85rem;">Ao finalizar a assinatura, você concorda com nossos Termos de Uso e Política de Privacidade.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script gerador de PIX dinâmico -->
    <script src="/static/js/pix-generator.js"></script>
    <!-- Script principal de pagamento -->
    <script src="/static/js/pagamento.js"></script>
{%endblock%}